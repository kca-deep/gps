<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS ì„ ë°•ê²€ì‚¬ ìœ„ì¹˜ì •ë³´ ìˆ˜ì§‘ AI Agent</title>
    <!-- Google Fonts - Inter + Noto Sans KR -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1e40af;
            --primary-gradient: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
            --secondary-color: #f59e0b;
            --accent-color: #10b981;
            --surface-color: #ffffff;
            --surface-dark: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            padding: 1rem;
        }

        .chat-container {
            width: 400px;
            height: 800px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-header {
            background: var(--primary-gradient);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            position: relative;
            overflow: hidden;
        }

        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
            z-index: 1;
        }

        .chat-header-right {
            position: relative;
            z-index: 1;
        }

        .chat-header-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 1;
        }

        .chat-header-info {
            position: relative;
            z-index: 1;
        }

        .chat-header-info h3 {
            font-size: 16px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .chat-header-info p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 2px;
        }

        .connection-status {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .connection-status::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
            animation: blink 2s infinite;
        }

        .connection-status.error::before {
            background: #ef4444;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--surface-dark);
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-end;
            gap: 12px;
            animation: fadeInUp 0.4s ease-out;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
            box-shadow: var(--shadow-md);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .message.ai .message-avatar {
            background: var(--primary-gradient);
        }

        .message-content {
            max-width: 70%;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .message.user .message-content {
            align-items: flex-end;
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: var(--radius-lg);
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 14px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .message-bubble:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message.ai .message-bubble {
            background: var(--surface-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .message-time {
            font-size: 11px;
            color: var(--text-muted);
            margin: 0 6px;
            font-weight: 500;
        }

        .quick-actions {
            padding: 8px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-top: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .quick-actions-title {
            display: none;
        }

        .quick-actions-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            justify-content: center;
        }

        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 4px;
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border: 1px solid transparent;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 1px 2px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            min-height: 36px;
            text-align: center;
        }

        .quick-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(30, 64, 175, 0.1), 
                rgba(59, 130, 246, 0.1), 
                rgba(96, 165, 250, 0.1));
            opacity: 0;
            transition: opacity 0.2s ease;
            border-radius: 10px;
        }

        .quick-action-btn::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background: linear-gradient(145deg, #ffffff, #f1f5f9);
            border-radius: 8px;
            z-index: -1;
            transition: all 0.2s ease;
        }

        .quick-action-btn .btn-icon {
            font-size: 16px;
            margin-bottom: 2px;
            transition: all 0.2s ease;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

        .quick-action-btn .btn-text {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.2px;
            transition: all 0.2s ease;
        }

        .quick-action-btn:hover {
            transform: translateY(-1px);
            border-color: rgba(30, 64, 175, 0.3);
            box-shadow: 
                0 4px 8px rgba(30, 64, 175, 0.15),
                0 2px 4px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .quick-action-btn:hover::before {
            opacity: 1;
        }

        .quick-action-btn:hover .btn-text {
            color: var(--primary-color);
            font-weight: 700;
        }

        .quick-action-btn:active {
            transform: translateY(0);
            transition: all 0.1s ease;
        }

        /* ê° ë²„íŠ¼ë³„ ê³ ìœ  ìƒ‰ìƒ */
        .quick-action-btn[data-action="ë¬´ì„ êµ­ ë“±ë¡í•´ì¤˜"]:hover {
            border-color: rgba(16, 185, 129, 0.4);
            background: linear-gradient(145deg, rgba(236, 253, 245, 0.8), rgba(209, 250, 229, 0.8));
        }

        .quick-action-btn[data-action="ë¬´ì„ êµ­ ë“±ë¡í•´ì¤˜"]:hover .btn-icon {
            filter: drop-shadow(0 2px 4px rgba(16, 185, 129, 0.4));
        }

        .quick-action-btn[data-action="GPS ì •ë³´ ë‹¤ì‹œ í™•ì¸"]:hover {
            border-color: rgba(245, 158, 11, 0.4);
            background: linear-gradient(145deg, rgba(255, 251, 235, 0.8), rgba(254, 243, 199, 0.8));
        }

        .quick-action-btn[data-action="GPS ì •ë³´ ë‹¤ì‹œ í™•ì¸"]:hover .btn-icon {
            filter: drop-shadow(0 2px 4px rgba(245, 158, 11, 0.4));
        }

        .quick-action-btn[data-action="ë¬´ì„ êµ­ ê²€ìƒ‰í•´ì¤˜"]:hover {
            border-color: rgba(139, 92, 246, 0.4);
            background: linear-gradient(145deg, rgba(245, 243, 255, 0.8), rgba(221, 214, 254, 0.8));
        }

        .quick-action-btn[data-action="ë¬´ì„ êµ­ ê²€ìƒ‰í•´ì¤˜"]:hover .btn-icon {
            filter: drop-shadow(0 2px 4px rgba(139, 92, 246, 0.4));
        }

        .quick-action-btn[data-action="ë‚´ ìœ„ì¹˜ ì£¼ë³€ ë¬´ì„ êµ­ ê²€ìƒ‰"]:hover {
            border-color: rgba(239, 68, 68, 0.4);
            background: linear-gradient(145deg, rgba(254, 242, 242, 0.8), rgba(254, 226, 226, 0.8));
        }

        .quick-action-btn[data-action="ë‚´ ìœ„ì¹˜ ì£¼ë³€ ë¬´ì„ êµ­ ê²€ìƒ‰"]:hover .btn-icon {
            filter: drop-shadow(0 2px 4px rgba(239, 68, 68, 0.4));
        }



        .chat-input {
            display: flex;
            padding: 14px 20px;
            background: var(--surface-color);
            border-top: 1px solid var(--border-color);
            gap: 12px;
            align-items: center;
        }

        .input-group {
            flex: 1;
            display: flex;
            background: var(--surface-dark);
            border-radius: var(--radius-xl);
            padding: 12px 16px;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .input-group:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .input-group.search-mode {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .input-group.search-mode .message-input {
            background: transparent;
        }

        .message-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 14px;
            color: var(--text-primary);
            font-family: inherit;
        }

        .message-input::placeholder {
            color: var(--text-muted);
        }

        .send-btn {
            width: 40px;
            height: 40px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .voice-btn {
            width: 40px;
            height: 40px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .send-btn:hover, .voice-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .voice-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .send-btn:disabled {
            background: var(--surface-dark);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 1.5s infinite;
        }

        .voice-btn.not-supported {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            color: var(--text-secondary);
            font-size: 13px;
            background: var(--surface-color);
            border-top: 1px solid var(--border-color);
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--primary-gradient);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { 
                transform: scale(0.6);
                opacity: 0.3;
            }
            40% { 
                transform: scale(1);
                opacity: 1;
            }
        }

        .error-message {
            background: linear-gradient(135deg, #fef2f2, #fecaca);
            color: #dc2626;
            padding: 12px 16px;
            border-radius: var(--radius-lg);
            font-size: 12px;
            margin: 12px 20px;
            border: 1px solid #fecaca;
            box-shadow: var(--shadow-sm);
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 3px;
            opacity: 0.6;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            opacity: 1;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .navigation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .navigation-modal.show {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        .navigation-modal-content {
            background: white;
            border-radius: var(--radius-xl);
            padding: 24px;
            max-width: 320px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            position: relative;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .navigation-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .navigation-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .navigation-modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-muted);
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .navigation-modal-close:hover {
            background: var(--surface-dark);
            color: var(--text-primary);
        }

        .navigation-option {
            display: flex;
            align-items: center;
            padding: 16px;
            margin-bottom: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            background: var(--surface-color);
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
        }

        .navigation-option:hover {
            border-color: var(--primary-color);
            background: rgba(30, 64, 175, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .navigation-option-icon {
            width: 40px;
            height: 40px;
            margin-right: 12px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: var(--surface-dark);
        }

        .navigation-option-info {
            flex: 1;
        }

        .navigation-option-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .navigation-option-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .navigation-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
            margin-left: 8px;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        .navigation-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
            background: linear-gradient(135deg, #059669, #047857);
        }

        .navigation-btn i {
            font-size: 10px;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }
            
            .chat-container {
                width: 100%;
                max-width: 480px;
                height: calc(100vh - 1rem);
            }
            
            .chat-header {
                padding: 12px 16px;
            }
            
            .chat-messages {
                padding: 16px;
            }
            
            .chat-input {
                padding: 12px 16px;
            }
            
            .quick-actions {
                padding: 6px 16px;
                background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                border-top: 1px solid #e2e8f0;
                border-bottom: 1px solid #e2e8f0;
            }

            .quick-actions-buttons {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }

            .quick-action-btn {
                padding: 6px 4px;
                min-height: 32px;
                border-radius: 8px;
            }

            .quick-action-btn .btn-icon {
                font-size: 14px;
                margin-bottom: 1px;
            }

            .quick-action-btn .btn-text {
                font-size: 10px;
                font-weight: 700;
                letter-spacing: 0.1px;
            }
        }

        @media (max-width: 480px) {
            .chat-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
            
            .chat-header {
                padding: 10px 12px;
            }

            .chat-header-info h3 {
                font-size: 14px;
            }
            
            .quick-actions {
                padding: 4px 12px;
                background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                border-top: 1px solid #e2e8f0;
                border-bottom: 1px solid #e2e8f0;
            }

            .quick-actions-buttons {
                grid-template-columns: repeat(4, 1fr);
                gap: 4px;
            }
            
            .quick-action-btn {
                padding: 4px 2px;
                min-height: 28px;
                border-radius: 6px;
            }

            .quick-action-btn .btn-icon {
                font-size: 12px;
                margin-bottom: 1px;
            }

            .quick-action-btn .btn-text {
                font-size: 9px;
                font-weight: 700;
                letter-spacing: 0.1px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- ì±„íŒ… í—¤ë” -->
        <div class="chat-header">
            <div class="chat-header-left">
                <div class="chat-header-icon">ğŸ“¡</div>
                <div class="chat-header-info">
                    <h3>GPS ì„ ë°•ê²€ì‚¬ ìœ„ì¹˜ì •ë³´ ìˆ˜ì§‘<br/>AI Agent</h3>
                </div>
            </div>
            <div class="chat-header-right">
                <div class="connection-status" id="connection-status-display">ì—°ê²°ë¨</div>
            </div>
        </div>

        <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
        <div class="chat-messages" id="chat-messages">
            <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <!-- íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° -->
        <div class="typing-indicator" id="typing-indicator">
            <span>AIê°€ ë‹µë³€ì„ ì¤€ë¹„ì¤‘</span>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <!-- ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="quick-actions" id="quick-actions" style="display: none;">
            <div class="quick-actions-title">ë¹ ë¥¸ ì•¡ì…˜</div>
            <div class="quick-actions-buttons" id="quick-actions-buttons">
                <!-- ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ì±„íŒ… ì…ë ¥ ì˜ì—­ -->
        <div class="chat-input">
            <div class="input-group">
                <input type="text" class="message-input" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="500">
            </div>
            <button class="send-btn" id="send-btn" type="button">
                â¤
            </button>
            <button class="voice-btn" id="voice-btn" type="button" title="ìŒì„± ì…ë ¥">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
    </div>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë‹¬ -->
    <div class="navigation-modal" id="navigation-modal">
        <div class="navigation-modal-content">
            <div class="navigation-modal-header">
                <div class="navigation-modal-title">ğŸ§­ ë„¤ë¹„ê²Œì´ì…˜ ì„ íƒ</div>
                <button class="navigation-modal-close" onclick="closeNavigationModal()">Ã—</button>
            </div>
            <div id="navigation-options">
                <!-- ë„¤ë¹„ê²Œì´ì…˜ ì˜µì…˜ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <script>
        class ChatApp {
            constructor() {
                this.sessionId = null;
                this.userLocation = null;
                this.apiBaseUrl = '/api/chat';
                
                this.messagesContainer = document.getElementById('chat-messages');
                this.messageInput = document.getElementById('message-input');
                this.sendBtn = document.getElementById('send-btn');
                this.typingIndicator = document.getElementById('typing-indicator');
                this.quickActionsContainer = document.getElementById('quick-actions-buttons');
                this.connectionStatus = document.getElementById('connection-status');
                this.connectionStatusDisplay = document.getElementById('connection-status-display');
                this.voiceBtn = document.getElementById('voice-btn');
                
                // ìŒì„± ì¸ì‹ ì„¤ì •
                this.recognition = null;
                this.isRecording = false;
                
                this.initializeEventListeners();
                this.initializeSpeechRecognition();
                
                // ìœ„ì¹˜ ì •ë³´ íšë“ í›„ ì„¸ì…˜ ì´ˆê¸°í™”
                this.requestLocationPermission().then(() => {
                    this.initializeSession();
                });
            }

            initializeEventListeners() {
                // ë©”ì‹œì§€ ì…ë ¥ ì´ë²¤íŠ¸
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // ì „ì†¡ ë²„íŠ¼ í´ë¦­
                this.sendBtn.addEventListener('click', () => {
                    this.sendMessage();
                });

                // ì…ë ¥ í•„ë“œ ë³€í™” ê°ì§€
                this.messageInput.addEventListener('input', () => {
                    this.sendBtn.disabled = !this.messageInput.value.trim();
                });

                // ìŒì„± ì…ë ¥ ë²„íŠ¼ í´ë¦­
                this.voiceBtn.addEventListener('click', () => {
                    this.toggleVoiceRecording();
                });
            }

            async initializeSession() {
                console.log('initializeSession í˜¸ì¶œë¨');
                console.log('í˜„ì¬ userLocation:', this.userLocation);
                
                // ê¸°ì¡´ ì„¸ì…˜ì´ ìˆë‹¤ë©´ ì„œë²„ì— ì‚­ì œ ìš”ì²­
                if (this.sessionId) {
                    console.log(`ê¸°ì¡´ ì„¸ì…˜ ${this.sessionId} ì‚­ì œ ìš”ì²­`);
                    try {
                        await fetch(`${this.apiBaseUrl}/session/${this.sessionId}`, {
                            method: 'DELETE'
                        });
                        console.log(`ê¸°ì¡´ ì„¸ì…˜ ${this.sessionId} ì‚­ì œ ì™„ë£Œ`);
                    } catch (error) {
                        console.warn(`ê¸°ì¡´ ì„¸ì…˜ ${this.sessionId} ì‚­ì œ ì‹¤íŒ¨:`, error);
                    }
                    this.sessionId = null;
                }

                try {
                    console.log('ìƒˆ ì„¸ì…˜ ì´ˆê¸°í™” fetch ìš”ì²­ ì‹œì‘');
                    const response = await fetch(`${this.apiBaseUrl}/session`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            location: this.userLocation
                        })
                    });
                    console.log('ì„¸ì…˜ ì´ˆê¸°í™” fetch ìš”ì²­ ì™„ë£Œ, ì‘ë‹µ ìƒíƒœ:', response.status);

                    if (response.ok) {
                        console.log('ì„¸ì…˜ ì´ˆê¸°í™” ì‘ë‹µ OK, JSON íŒŒì‹± ì‹œë„...');
                        const data = await response.json();
                        console.log('ì„¸ì…˜ ì´ˆê¸°í™” ì‘ë‹µ ë°ì´í„°:', data);
                        this.sessionId = data.session_id;
                        this.messagesContainer.innerHTML = '';
                        this.addMessage('ai', data.message);
                        
                        // í•­ìƒ ê³ ì •ëœ ë¹ ë¥¸ ì•¡ì…˜ë§Œ í‘œì‹œ (ì „ì²´ ë²„íŠ¼ ì œê±°)
                        this.updateQuickActions([
                            { action: 'ë¬´ì„ êµ­ ë“±ë¡í•´ì¤˜', text: 'ë“±ë¡', icon: 'ğŸ“¡' },
                            { action: 'GPS ì •ë³´ ë‹¤ì‹œ í™•ì¸', text: 'ì¬í™•ì¸', icon: 'ğŸ“' },
                            { action: 'ë¬´ì„ êµ­ ê²€ìƒ‰í•´ì¤˜', text: 'ê²€ìƒ‰', icon: 'ğŸ”' },
                            { action: 'ë‚´ ìœ„ì¹˜ ì£¼ë³€ ë¬´ì„ êµ­ ê²€ìƒ‰', text: 'ì£¼ë³€ê²€ìƒ‰', icon: 'ğŸ—ºï¸' }
                        ]);
                        
                        this.updateConnectionStatus('ì—°ê²°ë¨', 'success');
                    } else {
                        console.error('ì„¸ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨: ì‘ë‹µ ìƒíƒœ ì½”ë“œ', response.status);
                        const errorText = await response.text();
                        console.error('ì„¸ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨: ì‘ë‹µ ë³¸ë¬¸', errorText);
                        throw new Error(`ì„¸ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('ì„¸ì…˜ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                    this.updateConnectionStatus('ì—°ê²° ì‹¤íŒ¨', 'error');
                    this.showError('ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”.');
                    
                    // ì—°ê²° ì‹¤íŒ¨ ì‹œ GPS ìš”ì²­ë§Œ ì œê³µ
                    this.updateQuickActions([
                        { action: 'request_location', text: 'GPSìš”ì²­', icon: 'ğŸ“' }
                    ]);
                }
            }

            initializeSpeechRecognition() {
                // Web Speech API ì§€ì› í™•ì¸
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    console.log('ìŒì„± ì¸ì‹ì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
                    this.voiceBtn.classList.add('not-supported');
                    this.voiceBtn.title = 'ìŒì„± ì…ë ¥ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
                    this.voiceBtn.disabled = true;
                    return;
                }

                // SpeechRecognition ê°ì²´ ìƒì„±
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();

                // ìŒì„± ì¸ì‹ ì„¤ì •
                this.recognition.lang = 'ko-KR';
                this.recognition.continuous = false;
                this.recognition.interimResults = true;
                this.recognition.maxAlternatives = 1;

                // ìŒì„± ì¸ì‹ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                this.recognition.onstart = () => {
                    console.log('ìŒì„± ì¸ì‹ ì‹œì‘');
                    this.isRecording = true;
                    this.voiceBtn.classList.add('recording');
                    this.voiceBtn.title = 'ìŒì„± ì¸ì‹ ì¤‘... (í´ë¦­í•˜ì—¬ ì¤‘ë‹¨)';
                    this.messageInput.placeholder = 'ë§ì”€í•´ ì£¼ì„¸ìš”...';
                };

                this.recognition.onresult = (event) => {
                    let transcript = '';
                    let isFinal = false;

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            isFinal = true;
                        }
                    }

                    // ì‹¤ì‹œê°„ìœ¼ë¡œ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                    this.messageInput.value = transcript;
                    
                    if (isFinal) {
                        console.log('ìŒì„± ì¸ì‹ ì™„ë£Œ:', transcript);
                        this.sendBtn.disabled = !transcript.trim();
                    }
                };

                this.recognition.onerror = (event) => {
                    console.error('ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', event.error);
                    this.stopVoiceRecording();
                    
                    let errorMessage = 'ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    switch (event.error) {
                        case 'no-speech':
                            errorMessage = 'ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
                            break;
                        case 'audio-capture':
                            errorMessage = 'ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”.';
                            break;
                        case 'not-allowed':
                            errorMessage = 'ë§ˆì´í¬ ì‚¬ìš© ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                            break;
                        case 'network':
                            errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                            break;
                    }
                    this.showError(errorMessage);
                };

                this.recognition.onend = () => {
                    console.log('ìŒì„± ì¸ì‹ ì¢…ë£Œ');
                    this.stopVoiceRecording();
                };

                console.log('ìŒì„± ì¸ì‹ ì´ˆê¸°í™” ì™„ë£Œ');
            }

            toggleVoiceRecording() {
                if (!this.recognition) {
                    this.showError('ìŒì„± ì¸ì‹ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }

                if (this.isRecording) {
                    this.stopVoiceRecording();
                } else {
                    this.startVoiceRecording();
                }
            }

            startVoiceRecording() {
                if (!this.recognition || this.isRecording) return;

                try {
                    this.messageInput.value = '';
                    this.sendBtn.disabled = true;
                    this.recognition.start();
                } catch (error) {
                    console.error('ìŒì„± ì¸ì‹ ì‹œì‘ ì‹¤íŒ¨:', error);
                    this.showError('ìŒì„± ì¸ì‹ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            }

            stopVoiceRecording() {
                if (!this.recognition || !this.isRecording) return;

                try {
                    this.recognition.stop();
                } catch (error) {
                    console.error('ìŒì„± ì¸ì‹ ì¤‘ë‹¨ ì‹¤íŒ¨:', error);
                } finally {
                    this.isRecording = false;
                    this.voiceBtn.classList.remove('recording');
                    this.voiceBtn.title = 'ìŒì„± ì…ë ¥';
                    this.messageInput.placeholder = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
                }
            }

            async requestLocationPermission() {
                if ('geolocation' in navigator) {
                    try {
                        this.addMessage('ai', 'ğŸ“ GPS ìœ„ì¹˜ ê¶Œí•œì„ ìš”ì²­í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì—ì„œ "í—ˆìš©"ì„ í´ë¦­í•´ ì£¼ì„¸ìš”.');
                        
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                enableHighAccuracy: true,
                                timeout: 15000,
                                maximumAge: 300000
                            });
                        });

                        this.userLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };

                        console.log('ìœ„ì¹˜ ì •ë³´ íšë“ ì„±ê³µ:', this.userLocation);
                        
                        // GPS ì¢Œí‘œ íšë“ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ (ì£¼ì†Œ ë³€í™˜ í¬í•¨)
                        this.addMessage('ai', `âœ… GPS ìœ„ì¹˜ë¥¼ ì„±ê³µì ìœ¼ë¡œ íšë“í–ˆìŠµë‹ˆë‹¤!\nğŸ“ ìœ„ì¹˜: ${this.userLocation.latitude.toFixed(6)}, ${this.userLocation.longitude.toFixed(6)}\nì •í™•ë„: ì•½ ${Math.round(this.userLocation.accuracy)}m\n\nğŸ”„ ì£¼ì†Œ ë³€í™˜ ì¤‘...`);
                        
                        // ì£¼ì†Œ ë³€í™˜ê³¼ í•¨ê»˜ ìœ„ì¹˜ ì •ë³´ í‘œì‹œ
                        this.showGpsInfoWithAddressInitial(this.userLocation);
                        
                                                 // ê³ ì •ëœ ë¹ ë¥¸ ì•¡ì…˜ë§Œ ì—…ë°ì´íŠ¸ (ì „ì²´ ë²„íŠ¼ ì œê±°)
                         this.updateQuickActions([
                             { action: 'ë¬´ì„ êµ­ ë“±ë¡í•´ì¤˜', text: 'ë“±ë¡', icon: 'ğŸ“¡' },
                             { action: 'GPS ì •ë³´ ë‹¤ì‹œ í™•ì¸', text: 'ì¬í™•ì¸', icon: 'ğŸ“' },
                             { action: 'ë¬´ì„ êµ­ ê²€ìƒ‰í•´ì¤˜', text: 'ê²€ìƒ‰', icon: 'ğŸ”' },
                             { action: 'ë‚´ ìœ„ì¹˜ ì£¼ë³€ ë¬´ì„ êµ­ ê²€ìƒ‰', text: 'ì£¼ë³€ê²€ìƒ‰', icon: 'ğŸ—ºï¸' }
                         ]);
                        
                    } catch (error) {
                        console.log('ìœ„ì¹˜ ì •ë³´ ê±°ë¶€ ë˜ëŠ” ì˜¤ë¥˜:', error);
                        
                        let errorMessage = '';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'âŒ GPS ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nëŒ€ì•ˆ ì˜µì…˜:\n1. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”\n2. ìˆ˜ë™ìœ¼ë¡œ ì¢Œí‘œë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤\n3. ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì—¬ ì¢Œí‘œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'âŒ ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nGPS ì‹ í˜¸ê°€ ì•½í•˜ê±°ë‚˜ ì‹¤ë‚´ì—ì„œëŠ” ì •í™•í•œ ìœ„ì¹˜ë¥¼ ë°›ê¸° ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'â° ìœ„ì¹˜ ì •ë³´ ìš”ì²­ì´ ì‹œê°„ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
                                break;
                            default:
                                errorMessage = 'âŒ ìœ„ì¹˜ ì •ë³´ íšë“ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                        }
                        
                        this.addMessage('ai', errorMessage);
                        
                        // GPS ìš”ì²­ë§Œ ì œê³µ
                        this.updateQuickActions([
                            { action: 'request_location', text: 'GPSìš”ì²­', icon: 'ğŸ“' }
                        ]);
                    }
                } else {
                    console.log('Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
                    this.addMessage('ai', 'âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” GPS ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì‹œìŠ¤í…œì„ ì‚¬ìš©í•˜ë ¤ë©´ GPSê°€ ì§€ì›ë˜ëŠ” ë¸Œë¼ìš°ì €ë‚˜ ê¸°ê¸°ë¥¼ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
                    
                    this.updateQuickActions([]);
                }
                
                return Promise.resolve();
            }

            async handleQuickAction(action) {
                console.log(`handleQuickAction í˜¸ì¶œë¨: ${action}`);
                this.showTypingIndicator();

                try {
                                         // í˜„ì¬ ì‚¬ìš©ë˜ëŠ” ë¹ ê°„ ì•¡ì…˜ë“¤ (ì „ì²´ ë²„íŠ¼ ì œê±°)
                     const fixedActions = [
                         'ë¬´ì„ êµ­ ë“±ë¡í•´ì¤˜',
                         'GPS ì •ë³´ ë‹¤ì‹œ í™•ì¸',
                         'ë‚´ ìœ„ì¹˜ ì£¼ë³€ ë¬´ì„ êµ­ ê²€ìƒ‰',
                         'ë¬´ì„ êµ­ ê²€ìƒ‰í•´ì¤˜',
                         'request_location'
                     ];

                    if (!fixedActions.includes(action)) {
                        this.hideTypingIndicator();
                        this.showError(`ì•Œ ìˆ˜ ì—†ëŠ” ë¹ ë¥¸ ì•¡ì…˜: ${action}`);
                        return;
                    }

                    // íŠ¹ë³„í•œ ì•¡ì…˜ ì²˜ë¦¬
                    if (action === "request_location") {
                        console.log('GPS ê¶Œí•œ ìš”ì²­ ì²˜ë¦¬');
                        this.hideTypingIndicator();
                        await this.requestLocationPermission();
                        return;
                    }
                    
                    if (action === "GPS ì •ë³´ ë‹¤ì‹œ í™•ì¸") {
                        this.hideTypingIndicator();
                        if (this.userLocation) {
                            // GPS ì •ë³´ì™€ í•¨ê»˜ ì£¼ì†Œë„ í•¨ê»˜ í‘œì‹œ
                            this.showGpsInfoWithAddress(this.userLocation);
                        } else {
                            this.addMessage('ai', 'âŒ GPS ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
                            this.updateQuickActions([
                                { action: 'request_location', text: 'GPSìš”ì²­', icon: 'ğŸ“' }
                            ]);
                        }
                        return;
                    }
                    
                                         // ë°±ì—”ë“œ ë©”ì‹œì§€ ì „ì†¡ì´ í•„ìš”í•œ ì•¡ì…˜ë“¤ (ì „ì²´ ë²„íŠ¼ ì œê±°)
                     const messageActions = {
                         'ë¬´ì„ êµ­ ë“±ë¡í•´ì¤˜': 'ë¬´ì„ êµ­ ë“±ë¡í•´ì¤˜',
                         'ë‚´ ìœ„ì¹˜ ì£¼ë³€ ë¬´ì„ êµ­ ê²€ìƒ‰': 'ë‚´ ìœ„ì¹˜ ì£¼ë³€ ë¬´ì„ êµ­ ê²€ìƒ‰',
                         'ë¬´ì„ êµ­ ê²€ìƒ‰í•´ì¤˜': 'ë¬´ì„ êµ­ ê²€ìƒ‰í•´ì¤˜',
                         'ë„ì›€ë§': 'ë„ì›€ë§'
                     };
                    
                    if (messageActions[action]) {
                        console.log(`ë©”ì‹œì§€ ì•¡ì…˜ ì²˜ë¦¬: ${action} â†’ ${messageActions[action]}`);
                        console.log('ì„¸ì…˜ ID:', this.sessionId);
                        console.log('ì‚¬ìš©ì ìœ„ì¹˜:', this.userLocation);
                        this.hideTypingIndicator();
                        this.sendMessage(messageActions[action]);
                        return;
                    }

                } catch (error) {
                    console.error('ë¹ ë¥¸ ì•¡ì…˜ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    this.hideTypingIndicator();
                    this.showError(`ë¹ ë¥¸ ì•¡ì…˜ ì²˜ë¦¬ ì‹¤íŒ¨: ${action}`);
                }
            }

            async showGpsInfoWithAddressInitial(location) {
                try {
                    // ì£¼ì†Œ ë³€í™˜ API í˜¸ì¶œ
                    const response = await fetch('/api/chat/pinpoint-info', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            latitude: location.latitude,
                            longitude: location.longitude
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        let infoText = `ğŸ¯ ìœ„ì¹˜ ì •ë³´ê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n`;
                        infoText += `ğŸ—ºï¸ GPS ì¢Œí‘œ: ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}\n`;
                        infoText += `ğŸ“ ì •í™•ë„: ì•½ ${Math.round(location.accuracy)}m\n\n`;
                        
                        // ì£¼ì†Œ ì •ë³´ ì¶”ê°€
                        if (data.address_info && data.address_info.success) {
                            infoText += `ğŸ  ì£¼ì†Œ: ${data.address_info.address}\n`;
                            if (data.address_info.region_name) {
                                infoText += `ğŸ“ ì§€ì—­: ${data.address_info.region_name}\n`;
                            }
                            if (data.address_info.detailed_location && data.address_info.detailed_location !== data.address_info.address) {
                                infoText += `ğŸ“Œ ìƒì„¸ ìœ„ì¹˜: ${data.address_info.detailed_location}\n`;
                            }
                        } else {
                            infoText += `ğŸ  ì£¼ì†Œ: ë³€í™˜í•  ìˆ˜ ì—†ìŒ\n`;
                            if (data.address_info && data.address_info.error) {
                                infoText += `   (${data.address_info.error})\n`;
                            }
                        }
                        
                        // ì£¼ë³€ ë¬´ì„ êµ­ ì •ë³´ ì¶”ê°€
                        if (data.nearby_stations_summary) {
                            const summary = data.nearby_stations_summary;
                            infoText += `\nğŸ“¡ ì£¼ë³€ ë¬´ì„ êµ­: ${summary.total_count}ê°œ ë°œê²¬ (ë°˜ê²½ ${Math.round(summary.search_radius/1000)}km)\n`;
                        }
                        
                        infoText += `\në¬´ì„ êµ­ ë“±ë¡ì´ë‚˜ ê²€ìƒ‰ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸš€`;
                        
                        this.addMessage('ai', infoText);
                        
                        // ì§€ë„ í‘œì‹œ
                        const locationWithAddress = {
                            ...location,
                            address: data.address_info ? data.address_info.address : null,
                            region: data.address_info ? data.address_info.region_name : null
                        };
                        this.showLocationMap(locationWithAddress);
                        
                    } else {
                        // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì •ë³´ë§Œ í‘œì‹œ
                        this.addMessage('ai', `ğŸ¯ ìœ„ì¹˜ ì •ë³´ íšë“ ì™„ë£Œ!\n\nğŸ—ºï¸ GPS ì¢Œí‘œ: ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}\nğŸ“ ì •í™•ë„: ì•½ ${Math.round(location.accuracy)}m\n\nâŒ ì£¼ì†Œ ë³€í™˜ì— ì‹¤íŒ¨í–ˆì§€ë§Œ ì¢Œí‘œë¡œ ë¬´ì„ êµ­ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸš€`);
                        this.showLocationMap(location);
                    }
                } catch (error) {
                    console.error('GPS ì •ë³´ ë° ì£¼ì†Œ ë³€í™˜ ì˜¤ë¥˜:', error);
                    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ì •ë³´ë§Œ í‘œì‹œ
                    this.addMessage('ai', `ğŸ¯ ìœ„ì¹˜ ì •ë³´ íšë“ ì™„ë£Œ!\n\nğŸ—ºï¸ GPS ì¢Œí‘œ: ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}\nğŸ“ ì •í™•ë„: ì•½ ${Math.round(location.accuracy)}m\n\nâŒ ì£¼ì†Œ ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì§€ë§Œ ì¢Œí‘œë¡œ ë¬´ì„ êµ­ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸš€`);
                    this.showLocationMap(location);
                }
            }

            async showGpsInfoWithAddress(location) {
                try {
                    // GPS ì •ë³´ ë¨¼ì € í‘œì‹œ
                    this.addMessage('ai', `ğŸ“ GPS ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...\nìœ„ë„: ${location.latitude.toFixed(6)}\nê²½ë„: ${location.longitude.toFixed(6)}\nì •í™•ë„: ì•½ ${Math.round(location.accuracy)}m\n\nğŸ”„ ì£¼ì†Œ ë³€í™˜ ì¤‘...`);
                    
                    // ì£¼ì†Œ ë³€í™˜ API í˜¸ì¶œ
                    const response = await fetch('/api/chat/pinpoint-info', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            latitude: location.latitude,
                            longitude: location.longitude
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        let infoText = `ğŸ“ í˜„ì¬ GPS ì •ë³´:\n`;
                        infoText += `ğŸ—ºï¸ ì¢Œí‘œ: ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}\n`;
                        infoText += `ğŸ“ ì •í™•ë„: ì•½ ${Math.round(location.accuracy)}m\n\n`;
                        
                        // ì£¼ì†Œ ì •ë³´ ì¶”ê°€
                        if (data.address_info && data.address_info.success) {
                            infoText += `ğŸ  ì£¼ì†Œ: ${data.address_info.address}\n`;
                            if (data.address_info.region_name) {
                                infoText += `ğŸ“ ì§€ì—­: ${data.address_info.region_name}\n`;
                            }
                            if (data.address_info.detailed_location && data.address_info.detailed_location !== data.address_info.address) {
                                infoText += `ğŸ“Œ ìƒì„¸ ìœ„ì¹˜: ${data.address_info.detailed_location}\n`;
                            }
                        } else {
                            infoText += `ğŸ  ì£¼ì†Œ: ë³€í™˜ ì‹¤íŒ¨\n`;
                            if (data.address_info && data.address_info.error) {
                                infoText += `   ì˜¤ë¥˜: ${data.address_info.error}\n`;
                            }
                        }
                        
                        // ì£¼ë³€ ë¬´ì„ êµ­ ì •ë³´ ì¶”ê°€
                        if (data.nearby_stations_summary) {
                            const summary = data.nearby_stations_summary;
                            infoText += `\nğŸ“¡ ì£¼ë³€ ë¬´ì„ êµ­: ${summary.total_count}ê°œ (ë°˜ê²½ ${Math.round(summary.search_radius/1000)}km)`;
                        }
                        
                        this.addMessage('ai', infoText);
                        
                        // ì§€ë„ í‘œì‹œ
                        const locationWithAddress = {
                            ...location,
                            address: data.address_info ? data.address_info.address : null,
                            region: data.address_info ? data.address_info.region_name : null
                        };
                        this.showLocationMap(locationWithAddress);
                        
                    } else {
                        // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì •ë³´ë§Œ í‘œì‹œ
                        this.addMessage('ai', `ğŸ“ í˜„ì¬ GPS ì •ë³´:\nìœ„ë„: ${location.latitude.toFixed(6)}\nê²½ë„: ${location.longitude.toFixed(6)}\nì •í™•ë„: ì•½ ${Math.round(location.accuracy)}m\n\nâŒ ì£¼ì†Œ ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
                        this.showLocationMap(location);
                    }
                } catch (error) {
                    console.error('GPS ì •ë³´ ë° ì£¼ì†Œ ë³€í™˜ ì˜¤ë¥˜:', error);
                    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ì •ë³´ë§Œ í‘œì‹œ
                    this.addMessage('ai', `ğŸ“ í˜„ì¬ GPS ì •ë³´:\nìœ„ë„: ${location.latitude.toFixed(6)}\nê²½ë„: ${location.longitude.toFixed(6)}\nì •í™•ë„: ì•½ ${Math.round(location.accuracy)}m\n\nâŒ ì£¼ì†Œ ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
                    this.showLocationMap(location);
                }
            }

            showLocationMap(location) {
                const mapDiv = document.createElement('div');
                mapDiv.className = 'location-map';
                mapDiv.style.cssText = `
                    background: #f8f9fa;
                    border: 1px solid #e9ecef;
                    border-radius: 8px;
                    padding: 12px;
                    margin: 8px 0;
                    text-align: center;
                `;
                
                const { latitude, longitude } = location;
                const mapUrl = `https://maps.google.com/maps?q=${latitude},${longitude}&z=15&output=embed`;
                const linkUrl = `https://maps.google.com/maps?q=${latitude},${longitude}&z=15`;
                
                let titleText = 'ğŸ“ í˜„ì¬ ìœ„ì¹˜';
                if (location.station_name) {
                    titleText = `ğŸ“ ${location.station_name}`;
                } else if (location.address) {
                    titleText = 'ğŸ“ í˜„ì¬ ìœ„ì¹˜';
                }
                
                let coordinateText = `ìœ„ë„: ${latitude.toFixed(6)}, ê²½ë„: ${longitude.toFixed(6)}`;
                if (location.address) {
                    coordinateText += `<br><small style="color: #666;">${location.address}</small>`;
                }
                
                mapDiv.innerHTML = `
                    <div style="margin-bottom: 8px;">
                        <strong>${titleText}</strong>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                        ${coordinateText}
                    </div>
                    <iframe 
                        src="${mapUrl}"
                        width="100%" 
                        height="200" 
                        style="border: none; border-radius: 4px;"
                        loading="lazy">
                    </iframe>
                    <div style="margin-top: 8px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                        <a href="${linkUrl}" target="_blank" style="
                            color: #007bff; 
                            text-decoration: none; 
                            font-size: 12px;
                            padding: 4px 8px;
                            border: 1px solid #007bff;
                            border-radius: 4px;
                            display: inline-block;
                        ">
                            ğŸ—ºï¸ êµ¬ê¸€ ì§€ë„ì—ì„œ ë³´ê¸°
                        </a>
                        <button class="navigation-btn" onclick="window.chatApp.showNavigationModal(${latitude}, ${longitude}, '${titleText.replace('ğŸ“ ', '')}'); event.stopPropagation();" style="
                            margin-left: 0;
                            font-size: 12px;
                            padding: 4px 8px;
                        ">
                            <i class="fas fa-directions"></i> ê¸¸ì°¾ê¸°
                        </button>
                    </div>
                `;
                
                this.messagesContainer.appendChild(mapDiv);
                this.scrollToBottom();
            }

            async sendMessage(customMessage = null) {
                const message = customMessage || this.messageInput.value.trim();
                console.log(`sendMessage í˜¸ì¶œë¨: ${message}`);
                
                if (!message || !this.sessionId) {
                    console.log('ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆê±°ë‚˜ ì„¸ì…˜ IDê°€ ì—†ìŒ');
                    return;
                }

                // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
                this.addMessage('user', message);
                
                // ì»¤ìŠ¤í…€ ë©”ì‹œì§€ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì…ë ¥ í•„ë“œ í´ë¦¬ì–´
                if (!customMessage) {
                    this.messageInput.value = '';
                    this.sendBtn.disabled = true;
                }

                // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
                this.showTypingIndicator();

                try {
                    const response = await fetch(`${this.apiBaseUrl}/message`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            message: message,
                            location: this.userLocation
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        setTimeout(() => {
                            this.hideTypingIndicator();
                            this.addMessage('ai', data.response);
                            
                            // Function Calling ê²°ê³¼ ì²˜ë¦¬
                            if (data.function_called) {
                                this.handleFunctionResult(data.function_called, data.function_result);
                            }
                            
                            // ë°±ì—”ë“œì—ì„œ ì§ì ‘ ì „ë‹¬í•˜ëŠ” data í•„ë“œ ì²˜ë¦¬
                            if (data.data) {
                                console.log('data.data ì¡´ì¬. display_type:', data.data.display_type);
                                if (data.data.display_type === "nearby_stations_table") {
                                    this.showNearbyStationsTable(data.data.nearby_stations, data.data.radius);
                                } else if (data.data.search_results) {
                                    // ì¼ë°˜ ê²€ìƒ‰ ê²°ê³¼ í…Œì´ë¸” í‘œì‹œ
                                    this.showSearchResultsTable(data.data.search_results, data.data.total_count);
                                }
                            }

                            // ê²€ìƒ‰ì–´ ì…ë ¥ ìš”ì²­ì¸ ê²½ìš° ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
                            if (data.response && data.response.includes('ì–´ë–¤ ë¬´ì„ êµ­ì„ ê²€ìƒ‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                setTimeout(() => {
                                    this.messageInput.focus();
                                    this.messageInput.placeholder = 'ë¬´ì„ êµ­ëª…, ì§€ì—­ëª… ë˜ëŠ” í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
                                    document.querySelector('.input-group').classList.add('search-mode');
                                }, 100);
                            } else if (data.response && (data.response.includes('ê²€ìƒ‰ ê²°ê³¼') || data.response.includes('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤'))) {
                                // ê²€ìƒ‰ ê²°ê³¼ê°€ ë‚˜ì˜¨ ê²½ìš° ë˜ëŠ” ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš° placeholder ì›ë˜ëŒ€ë¡œ
                                this.messageInput.placeholder = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
                                document.querySelector('.input-group').classList.remove('search-mode');
                            }

                                                         // í•­ìƒ ê³ ì •ëœ ë¹ ë¥¸ ì•¡ì…˜ë§Œ í‘œì‹œ (ì „ì²´ ë²„íŠ¼ ì œê±°)
                             this.updateQuickActions([
                                 { action: 'ë¬´ì„ êµ­ ë“±ë¡í•´ì¤˜', text: 'ë“±ë¡', icon: 'ğŸ“¡' },
                                 { action: 'GPS ì •ë³´ ë‹¤ì‹œ í™•ì¸', text: 'ì¬í™•ì¸', icon: 'ğŸ“' },
                                 { action: 'ë¬´ì„ êµ­ ê²€ìƒ‰í•´ì¤˜', text: 'ê²€ìƒ‰', icon: 'ğŸ”' },
                                 { action: 'ë‚´ ìœ„ì¹˜ ì£¼ë³€ ë¬´ì„ êµ­ ê²€ìƒ‰', text: 'ì£¼ë³€ê²€ìƒ‰', icon: 'ğŸ—ºï¸' }
                             ]);
                            
                            if (data.error) {
                                this.showError(data.error);
                            }
                        }, 1000);
                    } else {
                        throw new Error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨');
                    }
                } catch (error) {
                    console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
                    this.hideTypingIndicator();
                    this.showError('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                }
            }

            handleFunctionResult(functionName, functionResult) {
                // GPS ìš”ì²­ì´ í•„ìš”í•œ ê²½ìš°
                if (functionResult.request_gps) {
                    this.requestLocationPermission();
                }
                
                // ì£¼ì†Œ ë³€í™˜ ê²°ê³¼ í‘œì‹œ
                if (functionName === 'getAddressFromTmap') {
                    if (functionResult.success) {
                        this.showLocationMap({
                            latitude: functionResult.latitude,
                            longitude: functionResult.longitude,
                            address: functionResult.address,
                            region: functionResult.region_name
                        });
                    }
                }
                
                // ë“±ë¡ ì™„ë£Œ ê²°ê³¼ í‘œì‹œ
                if (functionName === 'saveRadioStation') {
                    if (functionResult.success) {
                        this.showRegisteredStationInfo(functionResult.station_data, functionResult.station_id);
                    }
                }
                
                // ì—ëŸ¬ ì²˜ë¦¬
                if (!functionResult.success && functionResult.error) {
                    this.showError(functionResult.error);
                }
            }

            showRegisteredStationInfo(stationData, stationId) {
                const infoDiv = document.createElement('div');
                infoDiv.className = 'message ai';
                infoDiv.style.cssText = `
                    background: #e8f5e8;
                    border: 1px solid #c8e6c9;
                    border-radius: 8px;
                    padding: 12px;
                    margin: 8px 0;
                    font-size: 14px;
                `;

                infoDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 8px; color: #2e7d32;">ğŸ‰ ë¬´ì„ êµ­ ë“±ë¡ ì™„ë£Œ!</div>
                    <p><strong>ë¬´ì„ êµ­ëª…:</strong> ${stationData.station_name}</p>
                    <p><strong>ì¢…ë¥˜:</strong> ${stationData.station_type}</p>
                    <p><strong>ìœ„ì¹˜:</strong> ìœ„ë„ ${stationData.latitude.toFixed(6)}, ê²½ë„ ${stationData.longitude.toFixed(6)}</p>
                    <p><strong>ì£¼ì†Œ:</strong> ${stationData.address || 'ì •ë³´ ì—†ìŒ'}</p>
                    <p><strong>ë‹´ë‹¹ì:</strong> ${stationData.contact_person || 'ì •ë³´ ì—†ìŒ'}</p>
                    <p><strong>ì—°ë½ì²˜:</strong> ${stationData.contact_phone || 'ì •ë³´ ì—†ìŒ'}</p>
                    <p style="margin-top: 8px;"><strong>ë“±ë¡ë²ˆí˜¸:</strong> ${stationId}</p>
                `;
                this.messagesContainer.appendChild(infoDiv);
                this.scrollToBottom();
            }

            showSearchResultsTable(searchResults, totalCount) {
                console.log('showSearchResultsTable í˜¸ì¶œë¨. searchResults:', searchResults, 'totalCount:', totalCount);

                // ì œëª© ë©”ì‹œì§€ ì¶”ê°€
                const titleDiv = document.createElement('div');
                titleDiv.className = 'message ai';
                titleDiv.style.cssText = `
                    background: #e8f5e8;
                    border: 1px solid #c8e6c9;
                    border-radius: 8px;
                    padding: 12px;
                    margin: 8px 0;
                    font-size: 14px;
                    text-align: center;
                `;

                if (!searchResults || searchResults.length === 0) {
                    titleDiv.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 8px; color: #2e7d32; font-size: 16px;">
                            ğŸ” ê²€ìƒ‰ ê²°ê³¼ (0ê°œ)
                        </div>
                        <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    `;
                    this.messagesContainer.appendChild(titleDiv);
                    this.scrollToBottom();
                    return;
                }

                // ì œëª© í‘œì‹œ
                titleDiv.innerHTML = `
                    <div style="font-weight: bold; color: #2e7d32; font-size: 16px;">
                        ğŸ” ê²€ìƒ‰ ê²°ê³¼ (${totalCount}ê°œ)
                    </div>
                `;
                this.messagesContainer.appendChild(titleDiv);

                // í…Œì´ë¸”ì„ ë³„ë„ divë¡œ ìƒì„±
                const tableDiv = document.createElement('div');
                tableDiv.style.cssText = `
                    width: 100%;
                    margin: 8px 0;
                    padding: 0;
                `;

                let tableHtml = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px; border: 1px solid #ddd; background: white; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: left; font-weight: 600; color: #495057; white-space: nowrap;">ğŸ“¡ ë¬´ì„ êµ­ëª…</th>
                                <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: center; font-weight: 600; color: #495057; white-space: nowrap;">ğŸ·ï¸ ì¢…ë¥˜</th>
                                <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: center; font-weight: 600; color: #495057; white-space: nowrap;">ğŸ“ ê±°ë¦¬</th>
                                <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: center; font-weight: 600; color: #495057; white-space: nowrap;">ğŸ§­ ê¸¸ì°¾ê¸°</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                searchResults.forEach((result, index) => {
                    const station = result;  // ë°±ì—”ë“œì—ì„œ ì´ë¯¸ station.to_dict()ë¡œ ë³€í™˜ëœ ìƒíƒœ
                    const hasDistance = station.distance_meters !== undefined;
                    const distanceText = hasDistance ? `${(station.distance_meters / 1000).toFixed(2)}km` : 'N/A';
                    const rowBg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    
                    tableHtml += `
                        <tr style="background: ${rowBg}; transition: background-color 0.2s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'" onmouseout="this.style.backgroundColor='${rowBg}'">
                            <td style="padding: 10px 8px; border: 1px solid #dee2e6; vertical-align: middle;">
                                <a href="#" onclick="window.chatApp.showLocationMap({latitude: ${station.latitude}, longitude: ${station.longitude}, station_name: '${station.station_name}'}); return false;" 
                                   style="color: #1976d2; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 4px;">
                                    ğŸ“ ${station.station_name}
                                </a>
                                <div style="font-size: 10px; color: #666; margin-top: 2px;">
                                    ğŸ—ºï¸ ${station.latitude.toFixed(6)}, ${station.longitude.toFixed(6)}
                                </div>
                            </td>
                            <td style="padding: 10px 8px; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">
                                <span style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #1565c0; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                                    ${station.station_type || 'N/A'}
                                </span>
                            </td>
                            <td style="padding: 10px 8px; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">
                                <span style="color: #2e7d32; font-weight: 600; font-size: 11px;">${distanceText}</span>
                            </td>
                            <td style="padding: 10px 8px; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">
                                <button class="navigation-btn" onclick="window.chatApp.showNavigationModal(${station.latitude}, ${station.longitude}, '${station.station_name}'); event.stopPropagation();">
                                    <i class="fas fa-directions"></i> ê¸¸ì°¾ê¸°
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tableHtml += `
                        </tbody>
                    </table>
                `;

                tableDiv.innerHTML = tableHtml;
                this.messagesContainer.appendChild(tableDiv);

                // ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ë³„ë„ë¡œ ì¶”ê°€
                const infoDiv = document.createElement('div');
                infoDiv.className = 'message ai';
                infoDiv.style.cssText = `
                    background: #f8f9fa;
                    border: 1px solid #dee2e6;
                    border-radius: 8px;
                    padding: 8px 12px;
                    margin: 8px 0;
                    text-align: center;
                    font-size: 11px;
                    color: #6c757d;
                `;
                infoDiv.innerHTML = 'ğŸ’¡ ë¬´ì„ êµ­ëª…ì„ í´ë¦­í•˜ë©´ ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
                this.messagesContainer.appendChild(infoDiv);

                this.scrollToBottom();
            }

            showNearbyStationsTable(stations, radius) {
                console.log('showNearbyStationsTable í˜¸ì¶œë¨. stations:', stations, 'radius:', radius);

                // ì œëª© ë©”ì‹œì§€ ì¶”ê°€
                const titleDiv = document.createElement('div');
                titleDiv.className = 'message ai';
                titleDiv.style.cssText = `
                    background: #e8f5e8;
                    border: 1px solid #c8e6c9;
                    border-radius: 8px;
                    padding: 12px;
                    margin: 8px 0;
                    font-size: 14px;
                    text-align: center;
                `;

                if (!stations || stations.length === 0) {
                    titleDiv.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 8px; color: #2e7d32; font-size: 16px;">
                            ğŸ” í˜„ì¬ ìœ„ì¹˜ì—ì„œ ë°˜ê²½ ${radius}km ë‚´ ë¬´ì„ êµ­ (0ê°œ)
                        </div>
                        <p>ì£¼ë³€ì— ë¬´ì„ êµ­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    `;
                    this.messagesContainer.appendChild(titleDiv);
                    this.scrollToBottom();
                    return;
                }

                // ì œëª© í‘œì‹œ
                titleDiv.innerHTML = `
                    <div style="font-weight: bold; color: #2e7d32; font-size: 16px;">
                        ğŸ” í˜„ì¬ ìœ„ì¹˜ì—ì„œ ë°˜ê²½ ${radius}km ë‚´ ë¬´ì„ êµ­ (${stations.length}ê°œ)
                    </div>
                `;
                this.messagesContainer.appendChild(titleDiv);

                // í…Œì´ë¸”ì„ ë³„ë„ divë¡œ ìƒì„±
                const tableDiv = document.createElement('div');
                tableDiv.style.cssText = `
                    width: 100%;
                    margin: 8px 0;
                    padding: 0;
                `;

                let tableHtml = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px; border: 1px solid #ddd; background: white; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: left; font-weight: 600; color: #495057; white-space: nowrap;">ğŸ“¡ ë¬´ì„ êµ­ëª…</th>
                                <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: center; font-weight: 600; color: #495057; white-space: nowrap;">ğŸ·ï¸ ì¢…ë¥˜</th>
                                <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: center; font-weight: 600; color: #495057; white-space: nowrap;">ğŸ“ ê±°ë¦¬</th>
                                <th style="padding: 12px 8px; border: 1px solid #dee2e6; text-align: center; font-weight: 600; color: #495057; white-space: nowrap;">ğŸ§­ ê¸¸ì°¾ê¸°</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                stations.forEach((station, index) => {
                    const distanceKm = (station.distance_meters / 1000).toFixed(2);
                    const rowBg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    tableHtml += `
                        <tr style="background: ${rowBg}; transition: background-color 0.2s ease;" onmouseover="this.style.backgroundColor='#e3f2fd'" onmouseout="this.style.backgroundColor='${rowBg}'">
                            <td style="padding: 10px 8px; border: 1px solid #dee2e6; vertical-align: middle;">
                                <a href="#" onclick="window.chatApp.showLocationMap({latitude: ${station.latitude}, longitude: ${station.longitude}, station_name: '${station.station_name}'}); return false;" 
                                   style="color: #1976d2; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 4px;">
                                    ğŸ“ ${station.station_name}
                                </a>
                                <div style="font-size: 10px; color: #666; margin-top: 2px;">
                                    ğŸ—ºï¸ ${station.latitude.toFixed(6)}, ${station.longitude.toFixed(6)}
                                </div>
                            </td>
                            <td style="padding: 10px 8px; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">
                                <span style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #1565c0; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                                    ${station.station_type || 'N/A'}
                                </span>
                            </td>
                            <td style="padding: 10px 8px; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">
                                <span style="color: #2e7d32; font-weight: 600; font-size: 11px;">${distanceKm}km</span>
                            </td>
                            <td style="padding: 10px 8px; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">
                                <button class="navigation-btn" onclick="window.chatApp.showNavigationModal(${station.latitude}, ${station.longitude}, '${station.station_name}'); event.stopPropagation();">
                                    <i class="fas fa-directions"></i> ê¸¸ì°¾ê¸°
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tableHtml += `
                        </tbody>
                    </table>
                `;

                tableDiv.innerHTML = tableHtml;
                this.messagesContainer.appendChild(tableDiv);

                // ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ë³„ë„ë¡œ ì¶”ê°€
                const infoDiv = document.createElement('div');
                infoDiv.className = 'message ai';
                infoDiv.style.cssText = `
                    background: #f8f9fa;
                    border: 1px solid #dee2e6;
                    border-radius: 8px;
                    padding: 8px 12px;
                    margin: 8px 0;
                    text-align: center;
                    font-size: 11px;
                    color: #6c757d;
                `;
                infoDiv.innerHTML = 'ğŸ’¡ ë¬´ì„ êµ­ëª…ì„ í´ë¦­í•˜ë©´ ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
                this.messagesContainer.appendChild(infoDiv);

                this.scrollToBottom();
            }

            addMessage(sender, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;

                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = sender === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';

                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.innerHTML = content.replace(/\n/g, '<br>');

                const time = document.createElement('div');
                time.className = 'message-time';
                time.textContent = new Date().toLocaleTimeString('ko-KR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                contentDiv.appendChild(bubble);
                contentDiv.appendChild(time);
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);

                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            updateQuickActions(actions) {
                const quickActionsElement = document.getElementById('quick-actions');
                this.quickActionsContainer.innerHTML = '';

                // í•­ìƒ ê³ ì •ëœ ë¹ ë¥¸ ì•¡ì…˜ë§Œ í‘œì‹œ (ì•„ì´ì½˜ í¬í•¨, ì „ì²´ ë²„íŠ¼ ì œê±°)
                const fixedActions = [
                    { action: 'ë¬´ì„ êµ­ ë“±ë¡í•´ì¤˜', text: 'ë“±ë¡', icon: 'ğŸ“¡' },
                    { action: 'GPS ì •ë³´ ë‹¤ì‹œ í™•ì¸', text: 'ì¬í™•ì¸', icon: 'ğŸ“' },
                    { action: 'ë¬´ì„ êµ­ ê²€ìƒ‰í•´ì¤˜', text: 'ê²€ìƒ‰', icon: 'ğŸ”' },
                    { action: 'ë‚´ ìœ„ì¹˜ ì£¼ë³€ ë¬´ì„ êµ­ ê²€ìƒ‰', text: 'ì£¼ë³€ê²€ìƒ‰', icon: 'ğŸ—ºï¸' }
                ];

                quickActionsElement.style.display = 'block';

                fixedActions.forEach((action, index) => {
                    const button = document.createElement('button');
                    button.className = 'quick-action-btn';
                    button.setAttribute('data-action', action.action);
                    
                    // ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ë¥¼ ë¶„ë¦¬í•˜ì—¬ êµ¬ì¡°í™”
                    button.innerHTML = `
                        <div class="btn-icon">${action.icon}</div>
                        <div class="btn-text">${action.text}</div>
                    `;
                    
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log(`ë¹ ë¥¸ ì•¡ì…˜ í´ë¦­: ${action.action}`, action);
                        this.handleQuickAction(action.action);
                    });
                    this.quickActionsContainer.appendChild(button);
                });

                console.log(`ë¹ ë¥¸ ì•¡ì…˜ ì—…ë°ì´íŠ¸: ${fixedActions.length}ê°œ ë²„íŠ¼ ìƒì„±`, fixedActions);
            }

            showTypingIndicator() {
                this.typingIndicator.style.display = 'flex';
                this.scrollToBottom();
            }

            hideTypingIndicator() {
                this.typingIndicator.style.display = 'none';
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                
                this.messagesContainer.appendChild(errorDiv);
                this.scrollToBottom();

                // 5ì´ˆ í›„ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê±°
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 5000);
            }

            updateConnectionStatus(status, type) {
                this.connectionStatus.textContent = status;
                this.connectionStatus.style.color = type === 'error' ? '#c62828' : '#2e7d32';
                this.connectionStatusDisplay.textContent = status;
                
                if (type === 'error') {
                    this.connectionStatusDisplay.classList.add('error');
                } else {
                    this.connectionStatusDisplay.classList.remove('error');
                }
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }, 100);
            }

            showNavigationModal(latitude, longitude, stationName) {
                console.log(`ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë‹¬ ì—´ê¸°: ${stationName} (${latitude}, ${longitude})`);
                
                const modal = document.getElementById('navigation-modal');
                const optionsContainer = document.getElementById('navigation-options');
                
                // ë„¤ë¹„ê²Œì´ì…˜ ì˜µì…˜ë“¤ ìƒì„±
                const options = [
                    {
                        name: 'ì¹´ì¹´ì˜¤ë§µ',
                        icon: 'ğŸŸ¡',
                        desc: 'ì¹´ì¹´ì˜¤ë‚´ë¹„ë¡œ ê¸¸ì°¾ê¸°',
                        url: `kakaomap://route?ep=${latitude},${longitude}&by=CAR`,
                        webFallback: `https://map.kakao.com/link/to/${encodeURIComponent(stationName)},${latitude},${longitude}`
                    },
                    {
                        name: 'ë„¤ì´ë²„ì§€ë„',
                        icon: 'ğŸŸ¢',
                        desc: 'ë„¤ì´ë²„ì§€ë„ë¡œ ê¸¸ì°¾ê¸°',
                        url: `nmap://route/car?dlat=${latitude}&dlng=${longitude}&dname=${encodeURIComponent(stationName)}`,
                        webFallback: `https://map.naver.com/v5/directions/-/-/${latitude},${longitude},${encodeURIComponent(stationName)}/car`
                    },
                    {
                        name: 'êµ¬ê¸€ì§€ë„',
                        icon: 'ğŸ”µ',
                        desc: 'êµ¬ê¸€ì§€ë„ë¡œ ê¸¸ì°¾ê¸°',
                        url: `https://maps.google.com/maps?daddr=${latitude},${longitude}`,
                        webFallback: `https://maps.google.com/maps?daddr=${latitude},${longitude}`
                    }
                ];
                
                // ì˜µì…˜ HTML ìƒì„±
                optionsContainer.innerHTML = options.map(option => `
                    <div class="navigation-option" onclick="openNavigation('${option.url}', '${option.webFallback}', '${option.name}')">
                        <div class="navigation-option-icon">${option.icon}</div>
                        <div class="navigation-option-info">
                            <div class="navigation-option-name">${option.name}</div>
                            <div class="navigation-option-desc">${option.desc}</div>
                        </div>
                    </div>
                `).join('');
                
                // ëª¨ë‹¬ í‘œì‹œ
                modal.classList.add('show');
                
                // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        closeNavigationModal();
                    }
                };
            }
        }

        function closeNavigationModal() {
            const modal = document.getElementById('navigation-modal');
            modal.classList.remove('show');
            modal.onclick = null;
        }

        function openNavigation(url, webFallback, appName) {
            console.log(`ë„¤ë¹„ê²Œì´ì…˜ ì—´ê¸°: ${appName} - ${url}`);
            
            // ëª¨ë°”ì¼ì—ì„œ ì•± URL ìŠ¤í‚´ ì‹œë„
            if (isMobileDevice()) {
                // ì•± URL ìŠ¤í‚´ ì‹œë„
                window.location.href = url;
                
                // ì•±ì´ ì„¤ì¹˜ë˜ì§€ ì•Šì€ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì›¹ fallback ì„¤ì •
                setTimeout(() => {
                    if (confirm(`${appName} ì•±ì´ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì›¹ ë²„ì „ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        window.open(webFallback, '_blank');
                    }
                }, 1000);
            } else {
                // ë°ìŠ¤í¬í†±ì—ì„œëŠ” ì›¹ ë²„ì „ ì‚¬ìš©
                window.open(webFallback, '_blank');
            }
            
            closeNavigationModal();
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // ì•± ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            window.chatApp = new ChatApp();
        });
    </script>
</body>
</html>
